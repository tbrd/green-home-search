name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  api-test:
    name: API Tests
    runs-on: ubuntu-latest
    
    services:
      opensearch:
        image: opensearchproject/opensearch:2.11.0
        env:
          discovery.type: single-node
          plugins.security.disabled: true
          OPENSEARCH_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: 'api/requirements.txt'
    
    - name: Install dependencies
      working-directory: api
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Wait for OpenSearch
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:9200/_cluster/health; do sleep 2; done'
    
    - name: Create test index
      run: |
        curl -X PUT "http://localhost:9200/domestic-2023-certificates" -H 'Content-Type: application/json' -d'
        {
          "mappings": {
            "properties": {
              "LMK_KEY": {"type": "keyword"},
              "ADDRESS": {"type": "text"},
              "POSTCODE": {"type": "keyword"},
              "UPRN": {"type": "keyword"},
              "CURRENT_ENERGY_RATING": {"type": "keyword"},
              "CURRENT_ENERGY_EFFICIENCY": {"type": "integer"},
              "PROPERTY_TYPE": {"type": "keyword"},
              "LODGEMENT_DATETIME": {"type": "date"}
            }
          }
        }'
    
    - name: Run tests
      working-directory: api
      env:
        OPENSEARCH_URL: http://localhost:9200
        OPENSEARCH_USER: ""
        OPENSEARCH_PASS: ""
      run: |
        pytest -v

  web-lint-build:
    name: Web Lint & Build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'
    
    - name: Install dependencies
      working-directory: web
      run: npm ci
    
    - name: Run linter
      working-directory: web
      run: npm run lint
    
    - name: Build
      working-directory: web
      run: npm run build
